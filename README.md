# r3f for testing

## @react-three/drei can't go through shadow-cljs since v4.0


### r3f+drei, version at 2021-03-26, ok

package.json

    {
        "devDependencies": {
            "shadow-cljs": "^2.16.9"
        },
        "dependencies": {
            "@react-three/drei": "^3.11.2", 
            "react-three-fiber": "^5.3.22",
            "react": "^17.0.2",
            "react-dom": "^17.0.2",
            "three": "^0.128.0"
        }
    }



### r3f+drei, version at 2021-03-30, failed


    shadow-cljs - watching build :r3f-and-drei
    [:r3f-and-drei] Configuring build.
    [:r3f-and-drei] Compiling ...
    [:r3f-and-drei] Build failure:
    Closure compilation failed with 2 errors
    --- node_modules/three-stdlib/index.cjs.js:2
    Illegal variable reference before declaration: i
    --- node_modules/three-stdlib/index.cjs.js:2
    Illegal variable reference before declaration: t

some [BREAKING CHANGES] of @react-three/drei

[BREAKING CHANGES]:https://github.com/pmndrs/drei/releases?page=17

- "@react-three/drei": "^4.0.0",     // (2021-03-29)  three-stdlib is now the defacto pacakge over three/examples. minimum supported version of react-three/fiber is ">=6.0"
- "@react-three/fiber": "^6.0.0",    //  (2021-03-30), rename react-three-fiber to @react-three/fiber

package.json

    {
        "devDependencies": {
            "shadow-cljs": "^2.16.9"
        },
        "dependencies": {
            "@react-three/drei": "^4.0.0", 
            "@react-three/fiber": "^6.0.0",
            "react": "^17.0.2",
            "react-dom": "^17.0.2",
            "three": "^0.128.0"
        }
    }


### r3f-only, for all versions, ok

- "@react-three/fiber": "^7.0.10",    //  (2021-10-06)

package.json

    {
        "devDependencies": {
            "shadow-cljs": "^2.16.9"
        },
        "dependencies": {
            "@react-three/fiber": "^7.0.10",
            "react": "^17.0.2",
            "react-dom": "^17.0.2",
            "three": "^0.128.0"
        }
    }


## Solution

Thanks, @thheller! As he metioned [here] and in [blog post],  Google Closure Compiler sometimes doesn't like JS code that is otherwise valid, so we need to package the js library part with webpack.

[here]:https://github.com/thheller/shadow-cljs/issues/971
[blog post]:https://code.thheller.com/blog/shadow-cljs/2020/05/08/how-about-webpack-now.html#option-2-js-provider-external

1. Add `:js-provider :external` to builds in shadow-cljs.edn

         :js-options {:js-provider :external
                      :external-index "target/index.js"}

2. After shadow-cljs watch or compile, shadow will generate a `target/index.js` for js dependency

3. Use Webpack to package

        npx webpack --entry ./target/index.js --output-path public/js/libs

4. Add /js/libs/main.js to index.html, before the js file generated by shadow

        <script src="/js/libs/main.js" type="text/javascript"></script>
        <script src="/js/app.js" type="text/javascript"></script>
